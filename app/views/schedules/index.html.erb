<!-- app/views/schedules/index.html.erb -->
<h1><%= @selected_weekday %>のスケジュール一覧</h1>
<% time_slots = ["8:30", "9:00", "9:30", "10:00", "10:30", "11:00", "11:30", "12:00",
                 "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30"] %>

<div style="margin-bottom: 20px;">
  <% %w(月 火 水 木 金 土 ).each do |day| %>
    <%= link_to "#{day}曜日", schedules_path(weekday: day), style: "margin-right: 10px;" %>
  <% end %>
</div>

<%= link_to "新規スケジュールを登録", new_schedule_path, class: "button" %>

<table border="1" cellpadding="8" cellspacing="0">
  <thead>
    <tr>
      <th>時間帯</th>
      <% @users.each do |user| %>
        <th><%= user.name %></th>
      <% end %>
    </tr>
  </thead>

<tbody>
<% rendered_cells = {} %>

<% time_slots.each do |time| %>
  <tr>
    <td><%= time %></td>
    <% @users.each do |user| %>
      <% key = "#{user.id}-#{time}" %>
      <% if rendered_cells[key] %>
        <%# すでに表示したセルならスキップ %>
        <% next %>
      <% end %>

      <% match = @schedules.find do |s|
      s.user_id == user.id &&
      s.start_time.present? && s.end_time.present? &&
      s.start_time.strftime("%H:%M") < (Time.parse(time) + 30.minutes).strftime("%H:%M") &&
      s.end_time.strftime("%H:%M") > time
      end %>

      <% if match %>
        <% # row数（30分刻み）を計算 %>
        <% start_index = time_slots.index(time) %>
        <% end_index = time_slots.index(match.end_time.strftime("%H:%M")) || time_slots.length %>
        <% rowspan = end_index - start_index %>

        <%# 表示済みフラグを立てておく %>
        <% (start_index...end_index).each do |i| %>
          <% rendered_cells["#{user.id}-#{time_slots[i]}"] = true %>
        <% end %>

        <td rowspan="<%= rowspan %>" style="background-color: #d1f0d1;">
          <%= button_to "#{match.client.name}",
              schedule_path(match),
              method: :delete,
              data: { confirm: "削除しますか？" },
              form: { style: "display:inline;" },
              style: "background:none; border:none; color:red; text-decoration:underline; cursor:pointer;" %><br>

      <%= match.start_time.strftime("%H:%M") %>〜<%= match.end_time.strftime("%H:%M") %>
        </td>
      <% else %>
        <td style="background-color: #f0f0f0;"></td>
      <% end %>
    <% end %>
  </tr>
<% end %>
  </tbody>
</table>
