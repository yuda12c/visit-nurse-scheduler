<!-- app/views/schedules/index.html.erb -->
<h1><%= @selected_weekday %>のスケジュール一覧</h1>
<% time_slots = ["08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00",
                 "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00"] %>

<div class = "weekday_index">
  <% %w(月 火 水 木 金 土 ).each do |day| %>
    <%= link_to "#{day}曜日", schedules_path(weekday: day), style: "margin-right: 10px;" %>
  <% end %>
</div>

<div class="action-buttons">
<div class="schedule-new">
<%= link_to "スケジュール新規登録", new_schedule_path, class: "button" %><br></div>
<div class ="user-new">
<%= link_to "スタッフ新規登録", new_user_path, class: "button" %><br></div>
</div>

<table class="schedule-table" border="1" cellpadding="8" cellspacing="0">
  <thead>
    <tr>
      <th>時間帯</th>
      <% @users.each do |user| %>
        <th><%= link_to user.name, user_path(user) %></th>
      <% end %>
    </tr>
  </thead>

<tbody>
<% rendered_cells = {} %>

<% time_slots.each do |time| %>
  <tr>
    <td><%= time %></td>
    <% @users.each do |user| %>
      <% key = "#{user.id}-#{time}" %>
      <% if rendered_cells[key] %>
        <% next %>
      <% end %>
<% cell_schedules = @schedules.select do |s| 
  next if s.start_time.nil?

  rounded_start = s.start_time.change(min: s.start_time.min < 30 ? 0 : 30)
  s.user_id == user.id && rounded_start.strftime("%H:%M") == time
end %>

<td class="schedule-cell">
  <% if cell_schedules.any? %>
    <div class="multi-schedule-wrapper">
      <% cell_schedules.each do |schedule| %>
        <div class="multi-schedule-item">
          <button
            class="show-detail-button"
            data-id="<%= schedule.id %>"
            style="background:none; border:none; color:blue; text-decoration:underline; cursor:pointer;">
            <%= schedule.client.name %>
          </button><br>
          <%= schedule.start_time.strftime("%H:%M") %>〜<%= schedule.end_time.strftime("%H:%M") %>
        </div>
      <% end %>
    </div>
  <% end %>
</td>
<% end %>
  </tr>
<% end %>
  </tbody>
</table>
<!-- 詳細モーダルの表示先 -->
<div id="schedule-detail-modal" style="display: none;"></div>
